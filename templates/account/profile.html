<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" href="{% static 'CSS/profile_heder.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/profile.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/footer.css' %}">
</head>
<body>
{#    <header>#}
{#        <a href="{% url 'property-index' %}" class="site-title-link">#}
{#            <div>CastleApartments</div>#}
{#        </a>#}
{#            <form action="{% url 'logout' %}" method="post" class="profile-link">#}
{#                {% csrf_token %}#}
{#                <button type="submit" class="logout-button">Log Out</button>#}
{#            </form>#}
{##}
{#        <a href="{% url 'profile' %}" class="profile-link">#}
{#            {% if "http" in user.profile.profile_image|stringformat:"s" %}#}
{#                <div class="avatar" style="background-image: url('{{ user.profile.profile_image }}')"></div>#}
{#            {% elif user.profile.profile_image %}#}
{#                <div class="avatar" style="background-image: url('{{ user.profile.profile_image.url }}')"></div>#}
{#            {% else %}#}
{#                <div class="avatar" style="background-image: url('{% static "image/profile_icon.png" %}')"></div>#}
{#            {% endif %}#}
{#        </a>#}
{#    </header>#}
    <header>
        <a href="{% url 'property-index' %}" class="site-title-link">
            <div>CastleApartments</div>
        </a>

        <div class="auth-section">
            <form action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="logout-button">Log Out</button>
            </form>

            <a href="{% url 'profile' %}" class="profile-link">
                {% if "http" in user.profile.profile_image|stringformat:"s" %}
                    <div class="avatar" style="background-image: url('{{ user.profile.profile_image }}')"></div>
                {% elif user.profile.profile_image %}
                    <div class="avatar" style="background-image: url('{{ user.profile.profile_image.url }}')"></div>
                {% else %}
                    <div class="avatar" style="background-image: url('{% static "image/profile_icon.png" %}')"></div>
                {% endif %}
            </a>
        </div>
    </header>

    <main class="profile-container">
        {% if finalized_success %}
        <div class="success-message">
            Purchase offer successfully finalized!
        </div>
        <script>
          setTimeout(() => {
            document.querySelector('.success-message').style.display = 'none';
          }, 4000);
        </script>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" action="{% url 'profile' %}">
            {% csrf_token %}
            <h3>Update Username</h3>
            {{ user_form.username.label_tag }}
            {{ user_form.username }}

            <h3>Update Profile</h3>
            {{ form }}

            <input type="submit" value="Update Profile">
        </form>




        <div class="profile-header">
            <h1>{{ user.username|default:"User Profile" }}</h1>
            <div class="user-role">{{ user.role|title }}</div>
        </div>

        <div class="profile-info">
            <div class="info-item">
                <label>Email:</label>
                <p>{{ user.email }}</p>
            </div>

            <div class="offers-section">
                <h2>Submitted Offers</h2>
                <div class="offers-list">
                    {% if offers %}
                        {% for offer in offers %}
                            <div class="offer-card"> <!--show most recent offers for properties-->
                                <p><strong>Property:</strong>{{ offer.propertyId.propertyName }}</p>
                                <p><strong>Price:</strong>{{ offer.offerPrice }}</p>
                                <p><strong>Status:</strong>{{ offer.offerStatus }}</p>

                                {% if offer.id in finalized_offer_ids %} <!--cant finalize twice-->
                                    <button disabled class="finalize-btn">Sold</button>

                                {% elif offer.offerStatus == "Accepted" %} <!--if offer is accepted we can finalize-->
                                    <button type="button" class="finalize-btn" data-offer-id="{{ offer.id }}" onclick="openFinalizeModal({{ offer.id }})">
                                        Finalize
                                    </button>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}

                    <!-- Add dynamic offers here later -->
                        <div class="offer-placeholder">No offers submitted yet</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

<!-- Finalize Offer Modal -->
<div id="finalizeModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close-button" id="closeModal">&times;</span>
        <form method="POST" id="finalizeForm" action="">
            {% csrf_token %}

            <!-- Step 1: Contact Info -->
            <div class="form-step" id="step1">
                <h2>Step 1: Contact Info</h2>
                {{ finalize_form.nationalId.label_tag }} {{ finalize_form.nationalId }}
                {{ finalize_form.phoneNumber.label_tag }} {{ finalize_form.phoneNumber }}
                <button type="button" onclick="nextStep(2)">Next</button>
            </div>

            <!-- Step 2: Address -->
            <div class="form-step" id="step2" style="display:none;">
                <h2>Step 2: Address</h2>
                {{ finalize_form.address.label_tag }} {{ finalize_form.address }}
                <button type="button" onclick="nextStep(1)">Back</button>
                <button type="button" onclick="nextStep(3)">Next</button>
            </div>

            <!-- Step 3: Payment -->
            <div class="form-step" id="step3" style="display:none;">
                <h2>Step 3: Payment</h2>
                {{ finalize_form.paymentMethod.label_tag }} {{ finalize_form.paymentMethod }}

                <!-- Payment Sections -->
                <div id="creditCardFields" style="display:none;">
                    <label>Cardholder Name</label>
                    <input type="text" name="cardholder">
                    <label>Card Number</label>
                    <input type="text" name="card_number">
                    <label>Expiry Date</label>
                    <input type="text" name="card_expiry">
                    <label>CVC</label>
                    <input type="text" name="card_cvc">
                </div>

                <div id="bankFields" style="display:none;">
                    <label>Bank Name</label>
                    <input type="text" name="bank_name">
                    <label>Account Number</label>
                    <input type="text" name="account_number">
                </div>

                <div id="mortgageFields" style="display:none;">
                    <label>Mortgage Lender</label>
                    <input type="text" name="mortgage_lender">
                    <label>Agreement Reference</label>
                    <input type="text" name="agreement_ref">
                </div>

                <button type="button" onclick="nextStep(2)">Back</button>
                <button type="button" onclick="nextStep(4)">Next</button>
            </div>
            <!-- Step 4: Review -->
            <div class="form-step" id="step4" style="display:none;">
                <h2>Step 4: Review</h2>
                <div id="reviewContent">
                    <!-- Fill with JS -->
                </div>
                <button type="button" onclick="nextStep(3)">Back</button>
                <button type="submit">Confirm & Submit</button>
            </div>

        </form>
    </div>
</div>

<script src="{% static 'JS/finalize_modal.js' %}"></script>
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>CastleApartments</h3>
                <p>Real estate street 101, 101 Reykjav√≠k</p>
                <p>Work hours: Mon-Fri 09:00-16:00</p>
            </div>
            <div class="footer-section">
                <h4>Navigation</h4>
                <nav class="footer-links">
                    <a href="{% url 'property-index' %}">Home</a>
                    <a href="/about">About</a>
                    <a href="/contact">Contact us</a>
                    <a href="{% url 'property-index' %}">Properties</a>
                    <a href="/agencies">Agencies</a>
                </nav>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 CastleApartments. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>